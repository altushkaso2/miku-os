name: Miku OS Pre-Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso mtools git make gcc

      - name: Install Rust Nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src, llvm-tools-preview

      - name: Clone Limine (bootloader)
        run: |
          git clone https://github.com/limine-bootloader/limine.git --branch v8.x-binary --depth=1
          cd limine && make

      - name: Build Kernel
        run: |
          cargo build \
            --target x86_64-unknown-none \
            -Z build-std=core,compiler_builtins,alloc \
            -Z build-std-features=compiler-builtins-mem

      - name: Create ISO
        run: |
          mkdir -p iso_root/boot/limine
          mkdir -p iso_root/EFI/BOOT

          cp target/x86_64-unknown-none/debug/miku-os-release iso_root/boot/kernel
          cp limine.conf iso_root/boot/limine/limine.conf
          cp limine/limine-bios.sys iso_root/boot/limine/
          cp limine/limine-bios-cd.bin iso_root/boot/limine/
          cp limine/BOOTX64.EFI iso_root/EFI/BOOT/
          cp limine/BOOTIA32.EFI iso_root/EFI/BOOT/ || true

          dd if=/dev/zero of=iso_root/boot/limine/efi.img bs=1K count=4096
          mkfs.fat -F 12 iso_root/boot/limine/efi.img
          mmd -i iso_root/boot/limine/efi.img ::EFI
          mmd -i iso_root/boot/limine/efi.img ::EFI/BOOT
          mcopy -i iso_root/boot/limine/efi.img iso_root/EFI/BOOT/BOOTX64.EFI ::EFI/BOOT/BOOTX64.EFI
          mcopy -i iso_root/boot/limine/efi.img iso_root/EFI/BOOT/BOOTIA32.EFI ::EFI/BOOT/BOOTIA32.EFI || true

          xorriso -as mkisofs \
            -b boot/limine/limine-bios-cd.bin \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            --efi-boot boot/limine/efi.img \
            -efi-boot-part --efi-boot-image \
            --protective-msdos-label \
            iso_root -o miku-os.iso

          ./limine/limine bios-install miku-os.iso

      - name: Create disk
        run: |
          dd if=/dev/zero of=disk.img bs=1M count=16
          mkfs.ext2 -F disk.img

      - name: Check Artifacts
        run: |
          ls -lh miku-os.iso disk.img
          file miku-os.iso

      - name: Publish Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            miku-os.iso
            disk.img
          fail_on_unmatched_files: false
          generate_release_notes: true
